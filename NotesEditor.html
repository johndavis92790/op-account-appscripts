<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Account Notes</title>
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #fff;
      color: #1a1a2e;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
      color: white;
      padding: 12px 14px;
      flex-shrink: 0;
    }
    
    .header h1 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .save-status {
      font-size: 11px;
      opacity: 0.7;
      white-space: nowrap;
    }
    .save-status.saving { opacity: 1; color: #ffd166; }
    .save-status.saved { opacity: 1; color: #06d6a0; }
    .save-status.error { opacity: 1; color: #ef476f; }
    
    /* Account selector */
    .selector {
      padding: 8px 10px;
      background: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }
    
    .selector select {
      width: 100%;
      padding: 7px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 13px;
      background: white;
      color: #333;
      outline: none;
      cursor: pointer;
    }
    
    .selector select:focus {
      border-color: #0f3460;
    }
    
    /* Editor area */
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .ql-toolbar.ql-snow {
      border: none;
      border-bottom: 1px solid #e8e8e8;
      padding: 4px 6px;
      background: #fafafa;
      flex-shrink: 0;
    }
    
    .ql-toolbar .ql-formats {
      margin-right: 4px;
    }
    
    .ql-toolbar button {
      width: 24px;
      height: 24px;
    }
    
    .ql-container.ql-snow {
      border: none;
      font-size: 13px;
      line-height: 1.6;
      flex: 1;
      overflow-y: auto;
    }
    
    .ql-editor {
      padding: 10px 12px;
      min-height: 100%;
    }
    
    .ql-editor.ql-blank::before {
      font-size: 13px;
      color: #aaa;
      font-style: italic;
    }
    
    .ql-editor h1 { font-size: 18px; margin-bottom: 6px; }
    .ql-editor h2 { font-size: 15px; margin-bottom: 5px; }
    .ql-editor h3 { font-size: 13px; margin-bottom: 4px; font-weight: 600; }
    .ql-editor p { margin-bottom: 4px; }
    .ql-editor ul, .ql-editor ol { margin-bottom: 4px; padding-left: 18px; }
    .ql-editor li { margin-bottom: 2px; }
    
    /* Footer */
    .footer {
      padding: 6px 10px;
      background: #f9f9f9;
      border-top: 1px solid #e8e8e8;
      font-size: 11px;
      color: #999;
      flex-shrink: 0;
      text-align: center;
    }
    
    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      flex-direction: column;
      gap: 10px;
    }
    .loading-overlay.hidden { display: none; }
    
    .spinner {
      width: 28px;
      height: 28px;
      border: 3px solid #e0e0e0;
      border-top-color: #0f3460;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text { font-size: 13px; color: #666; }
    
    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>

  <!-- Loading overlay -->
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Loading accounts...</div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-row">
      <h1>Account Notes</h1>
      <span class="save-status" id="save-status"></span>
    </div>
  </div>

  <!-- Account selector -->
  <div class="selector">
    <select id="account-select" disabled>
      <option value="">Loading accounts...</option>
    </select>
  </div>

  <!-- Editor (hidden until account selected) -->
  <div class="editor-area" id="editor-area" style="display:none;">
    <div id="editor"></div>
  </div>

  <!-- Empty state (shown when no account selected) -->
  <div class="empty-state" id="empty-state">
    Select an account above to<br>view or edit notes
  </div>

  <!-- Footer -->
  <div class="footer" id="footer"></div>

  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    var quill = null;
    var currentAccountId = null;
    var currentAccountName = null;
    var hasUnsavedChanges = false;
    var isSaving = false;
    var autoSaveTimer = null;
    var accounts = [];

    // Initialize - load account list
    function init() {
      google.script.run
        .withSuccessHandler(function(result) {
          accounts = result || [];
          populateDropdown(accounts);
          document.getElementById('loading').classList.add('hidden');
        })
        .withFailureHandler(function(err) {
          document.getElementById('loading').classList.add('hidden');
          var sel = document.getElementById('account-select');
          sel.innerHTML = '<option value="">Error loading accounts</option>';
          console.error(err);
        })
        .getAccountListForNotes();
    }

    function populateDropdown(accounts) {
      var sel = document.getElementById('account-select');
      sel.innerHTML = '<option value="">-- Select Account (' + accounts.length + ') --</option>';
      
      accounts.forEach(function(acct) {
        var opt = document.createElement('option');
        opt.value = acct.id;
        opt.textContent = acct.name + (acct.hasNotes ? ' *' : '');
        opt.dataset.name = acct.name;
        sel.appendChild(opt);
      });
      
      sel.disabled = false;
      
      sel.addEventListener('change', function() {
        var selectedOption = sel.options[sel.selectedIndex];
        if (sel.value) {
          switchAccount(sel.value, selectedOption.dataset.name);
        } else {
          hideEditor();
        }
      });
    }

    function switchAccount(accountId, accountName) {
      // Save current notes first if needed
      if (hasUnsavedChanges && currentAccountId) {
        saveNotesSync();
      }
      
      currentAccountId = accountId;
      currentAccountName = accountName;
      
      showEditor();
      loadNotes();
    }

    function showEditor() {
      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('editor-area').style.display = 'flex';
      
      if (!quill) {
        quill = new Quill('#editor', {
          theme: 'snow',
          placeholder: 'Start writing notes...',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline'],
              [{ 'color': [] }],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              ['blockquote', 'link'],
              ['clean']
            ]
          }
        });
        
        // Auto-save on every change (debounced 1.5s)
        quill.on('text-change', function(delta, oldDelta, source) {
          if (source !== 'user') return;
          hasUnsavedChanges = true;
          updateStatus('Typing...', '');
          
          clearTimeout(autoSaveTimer);
          autoSaveTimer = setTimeout(function() {
            if (hasUnsavedChanges && !isSaving) saveNotes();
          }, 1500);
        });
      }
      
      quill.enable();
      quill.setText('');
      quill.root.setAttribute('data-placeholder', 'Start writing notes for ' + currentAccountName + '...');
    }

    function hideEditor() {
      document.getElementById('editor-area').style.display = 'none';
      document.getElementById('empty-state').style.display = 'flex';
      document.getElementById('footer').textContent = '';
      updateStatus('', '');
      currentAccountId = null;
      currentAccountName = null;
    }

    function loadNotes() {
      if (!currentAccountId) return;
      
      quill.enable(false);
      updateStatus('Loading...', 'saving');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.content && result.content !== '<p><br></p>') {
            quill.root.innerHTML = result.content;
          } else {
            quill.setText('');
          }
          quill.enable();
          hasUnsavedChanges = false;
          
          if (result && result.lastSaved) {
            document.getElementById('footer').textContent = 'Last saved: ' + result.lastSaved;
          } else {
            document.getElementById('footer').textContent = 'No notes yet';
          }
          updateStatus('', '');
        })
        .withFailureHandler(function(err) {
          quill.enable();
          updateStatus('Load failed', 'error');
          console.error('Load failed:', err);
        })
        .loadAccountNotes(currentAccountId);
    }

    function saveNotes() {
      if (!quill || !currentAccountId || isSaving) return;
      
      var content = quill.root.innerHTML;
      
      // Don't save empty content
      if (content === '<p><br></p>') {
        hasUnsavedChanges = false;
        return;
      }
      
      isSaving = true;
      updateStatus('Saving...', 'saving');
      
      google.script.run
        .withSuccessHandler(function(result) {
          isSaving = false;
          hasUnsavedChanges = false;
          updateStatus('Saved', 'saved');
          
          if (result && result.lastSaved) {
            document.getElementById('footer').textContent = 'Last saved: ' + result.lastSaved;
          }
          
          // Update the dropdown to show asterisk for accounts with notes
          updateDropdownIndicator(currentAccountId, true);
          
          setTimeout(function() {
            if (!hasUnsavedChanges) {
              updateStatus('', '');
            }
          }, 2000);
        })
        .withFailureHandler(function(err) {
          isSaving = false;
          updateStatus('Save failed', 'error');
          console.error('Save failed:', err);
          
          // Retry after 3s
          setTimeout(function() {
            if (hasUnsavedChanges && !isSaving) saveNotes();
          }, 3000);
        })
        .saveAccountNotes(currentAccountId, currentAccountName, content);
    }

    // Synchronous-style save (fire and forget) for account switching
    function saveNotesSync() {
      if (!quill || !currentAccountId) return;
      var content = quill.root.innerHTML;
      if (content === '<p><br></p>') return;
      
      google.script.run.saveAccountNotes(currentAccountId, currentAccountName, content);
      hasUnsavedChanges = false;
    }

    function updateStatus(text, cls) {
      var el = document.getElementById('save-status');
      el.textContent = text;
      el.className = 'save-status' + (cls ? ' ' + cls : '');
    }

    function updateDropdownIndicator(accountId, hasNotes) {
      var sel = document.getElementById('account-select');
      for (var i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value === accountId) {
          var name = sel.options[i].dataset.name;
          if (name) {
            sel.options[i].textContent = name + (hasNotes ? ' *' : '');
          }
          break;
        }
      }
    }

    // Keyboard shortcut: Ctrl/Cmd + S
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        clearTimeout(autoSaveTimer);
        if (currentAccountId && hasUnsavedChanges) saveNotes();
      }
    });

    init();
  </script>
</body>
</html>
