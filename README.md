# OP Account AppScripts â€” LLM Context Document

**Purpose:** This document is the single source of truth for an LLM working in this codebase. It describes the full system architecture, all data flows, every sheet and file, key functions, automation schedules, and how to make changes correctly.

**Links:**
- Google Sheet: `https://docs.google.com/spreadsheets/d/1-cEjGfOMnQMObzwvqLgos19VIOhGxW8TE6NwMVf749c/edit`
- GitHub Repo: `https://github.com/johndavis92790/op-account-appscripts`
- Apps Script: accessible via `clasp open` or Extensions â†’ Apps Script in the sheet

**Dev commands:**
```bash
clasp push        # push local JS files to Apps Script
clasp pull        # pull from Apps Script to local
clasp open        # open Apps Script editor in browser
git add -A && git commit -m "..." && git push origin main
```

---

## System Overview

This is a Google Apps Script project attached to a single Google Spreadsheet. It aggregates account data from multiple sources (Domo CSV exports, Gmail, Google Calendar, GitHub Projects, webhooks) into a unified view for managing a book of customer accounts. The primary user is an account manager (John Davis) at ObservePoint.

**Core concept:** Domo sends scheduled CSV exports via email. Those CSVs are the source of truth for which accounts are active. Everything else (emails, calendar events, GitHub tasks, meeting recaps, notes) is joined to accounts via Account ID (Salesforce-style ID, e.g. `0010W00002ZqiEdQAJ`).

---

## Google Sheet Structure

All sheets live in one spreadsheet. Sheets marked `[hidden]` are hidden by default.

| Sheet Name | Source | Description |
|---|---|---|
| `Renewal Opportunities` | Domo CSV via Gmail | Active renewal opps; primary filter for "active accounts" |
| `Opptys Report` | Domo CSV via Gmail | All opportunities; used to join opp ID â†’ opp name |
| `Accounts Card Report` | Domo CSV via Gmail | All accounts with Salesforce IDs; base account table |
| `Account Data Raw` | Generated by script | Consolidated view joining all data sources per account |
| `Email Communications` | GmailImport.js | Emails matched to accounts by domain |
| `Calendar Events` | CalendarImport.js | Calendar events matched to accounts by attendee domain |
| `GitHub Tasks` | GitHubImport.js | GitHub project board tasks matched to accounts by label |
| `Webhook Meeting Recaps` | WebhookHandler.js | AI meeting recaps received via POST webhook |
| `Meeting Action Items` | WebhookHandler.js | Action items extracted from meeting recaps |
| `Accounts to Email Domains Mapping` | Manual | Maps Account ID â†’ domain(s) for email/calendar/meeting matching |
| `Notes Storage` `[hidden]` | AccountNotes.js | Rich text notes per account (Quill HTML format) |
| `New Customer Detection Log` | NewCustomerDetection.js | Tracks new/removed customer detection baseline |

---

## File Map

Every `.js` file in this repo is a Google Apps Script file. They share a single global scope.

### Data Import

| File | Purpose |
|---|---|
| `EmailConfig.js` | Defines `EMAIL_CONFIGS` array â€” all CSV import configurations |
| `EmailToSheet.js` | Core CSV import logic; reads Gmail, parses CSV, writes to sheet; builds the `OP Account Tools` custom menu |
| `EmailToSheetManual.js` | Manual/one-off import helpers |
| `GmailImport.js` | Imports emails from Gmail matched to accounts by domain; writes to `Email Communications` |
| `CalendarImport.js` | Imports Google Calendar events matched to accounts by attendee domain; writes to `Calendar Events` |
| `CalendarConfig.js` | Config for calendar import (calendar ID, sheet name, date range) |
| `GitHubImport.js` | Syncs GitHub Projects board via GraphQL API; writes to `GitHub Tasks` |
| `GitHubConfig.js` | Config for GitHub import (org, project number, token key) |
| `GitHubAccountSync.js` | Matches GitHub tasks to accounts via issue labels (`account: Name`) |
| `GitHubIssueCreator.js` | Creates GitHub issues from the sheet UI |
| `WebhookHandler.js` | Receives POST webhook from Fireflies/AI meeting tool; parses recap + action items; matches to account by attendee email domain |

### Data Processing

| File | Purpose |
|---|---|
| `AccountDataRaw.js` | Main aggregation script â€” joins all sources into `Account Data Raw` sheet |
| `AccountMapping.js` | Shared utilities: domainâ†’account lookup, `extractOpportunityNameFromLink()`, etc. |
| `MeetingCalendarMatcher.js` | Links calendar events to meeting recaps by time overlap |
| `NewCustomerDetection.js` | Daily job: detects new/removed accounts in Renewal Opportunities; auto-creates notes entries |

### Data Integrity

| File | Purpose |
|---|---|
| `FixEmailAccountReferences.js` | One-time + maintenance: fixes Email Communications rows where Account ID column stored a name instead of an ID |
| `FixMissingAccounts.js` | Retroactively assigns Account IDs to meeting recaps that have no account match; also has `analyzeMissingDomainsManual()` |
| `ComprehensiveRemapping.js` | Verifies and repairs all foreign key relationships across all tables |
| `DiagnoseAccountDataRaw.js` | Diagnostic/debug script for Account Data Raw generation issues |

### Notes

| File | Purpose |
|---|---|
| `AccountNotes.js` | Backend for notes editor: `getAccountListForNotes()`, `loadAccountNotes(accountId)`, `saveAccountNotes(accountId, accountName, content)`, `openNotesSidebar()` |
| `NotesEditor.html` | Frontend sidebar using Quill.js rich text editor; calls AccountNotes.js via `google.script.run` |

### Config

| File | Purpose |
|---|---|
| `appsscript.json` | Apps Script manifest (OAuth scopes, timezone, runtime) |

---

## Data Flow: How Account Matching Works

The entire system hinges on matching external data (emails, calendar events, meeting recaps) to accounts. The matching chain is:

```
External email/attendee domain
    â†’ "Accounts to Email Domains Mapping" sheet (manual mapping)
    â†’ Account ID (Salesforce ID)
    â†’ Accounts Card Report
```

**Key rule:** The `Accounts to Email Domains Mapping` sheet must be kept up to date. When a new customer is added, their email domain(s) must be manually added to this sheet. Without it, emails, calendar events, and meeting recaps will not be matched to that account.

**Format of mapping sheet:**
- Column A: Account ID (e.g. `0010W00002ZqiEdQAJ`)
- Column B: Account Name
- Column C+: Domains (comma-separated, e.g. `acme.com,acmecorp.com`)

---

## Data Flow: Active Account Filtering

"Active" accounts are those that appear in `Renewal Opportunities`. The filter chain used in `AccountDataRaw.js` and `AccountNotes.js`:

```
Renewal Opportunities.Link to SF Opportunity
    â†’ extractOpportunityNameFromLink() â†’ opp name
    â†’ Opptys Report (name â†’ ID lookup)
    â†’ Accounts Card Report.next_renewal_opportunity_id
    â†’ Account ID
```

Any account in `Accounts Card Report` that does NOT have a matching opp in `Renewal Opportunities` is considered **Inactive**. Account Data Raw shows all accounts but marks them Active/Inactive in column B.

---

## Data Flow: Account Data Raw Generation

`generateAccountDataRaw()` in `AccountDataRaw.js` is the main aggregation function. It:
1. Loads all source sheets
2. Filters to active accounts (via opp chain above)
3. For each account, joins: emails (by Account ID), calendar events (by Account ID), GitHub tasks (by Account ID), meeting recaps (by Account ID), meeting action items (by recap ID), notes status
4. Writes consolidated rows to `Account Data Raw` sheet

**Account Data Raw columns include:**
- Account ID, Account Name, Account Status (Active/Inactive)
- Renewal date, ARR, opportunity details
- Emails array (Message IDs), Calendar Events array (Event IDs)
- GitHub Tasks array (Task IDs)
- Meeting Recaps array (Recap IDs), Meeting Action Items array (`{RecapID}_{index}`)
- Notes status (has notes: true/false)

---

## Data Flow: CSV Import (Domo â†’ Sheets)

Domo sends scheduled email reports with CSV attachments. `EmailToSheet.js` + `EmailConfig.js` handle this.

**Current CSV configs in `EmailConfig.js`:**
```javascript
EMAIL_CONFIGS = [
  { id: 'renewal-opportunities', sheetName: 'Renewal Opportunities',
    emailSearchQuery: 'subject:"Report - Master - Renewal Opportunities" has:attachment filename:csv newer_than:1d' },
  { id: 'opptys-report', sheetName: 'Opptys Report',
    emailSearchQuery: 'subject:"Report - John Opptys Report" has:attachment filename:csv newer_than:1d' },
  { id: 'accounts-card', sheetName: 'Accounts Card Report',
    emailSearchQuery: 'subject:"Report - John Accounts Card Report" has:attachment filename:csv newer_than:1d' }
]
```

**To add a new CSV import:** Add an entry to `EMAIL_CONFIGS` in `EmailConfig.js`. The menu auto-generates from this array. No other changes needed.

---

## Data Flow: GitHub Integration

- Uses GitHub GraphQL API with a Personal Access Token stored in Apps Script Script Properties as `GITHUB_TOKEN`
- Syncs the GitHub Projects board (project number configured in `GitHubConfig.js`)
- Tasks are matched to accounts via labels formatted as `account: Account Name`
- Rate limit: 5,000 requests/hour; even at 1-min sync intervals only ~60/hour are used

**To set token:** In Apps Script editor, go to Project Settings â†’ Script Properties â†’ add `GITHUB_TOKEN`.

---

## Data Flow: Webhook (Meeting Recaps)

`WebhookHandler.js` exposes a `doPost(e)` function that receives AI meeting recap webhooks (from Fireflies or similar). It:
1. Parses attendees (both actual and invited)
2. Filters out `@observepoint.com` emails
3. Extracts domains from external attendee emails
4. Looks up domain in `Accounts to Email Domains Mapping`
5. Assigns Account ID, Account Name, Opportunity ID, Opportunity Name, Mapped Domain
6. Writes to `Webhook Meeting Recaps` and `Meeting Action Items` sheets

**If no account match is found:** The recap is still stored but with blank Account ID. Run `fixMissingAccountsInMeetingRecapsManual()` after adding missing domains to the mapping sheet.

---

## Notes System

Notes are stored as Quill.js-compatible HTML in the `Notes Storage` sheet (hidden).

**Notes Storage schema:** `Account ID | Account Name | Notes Content | Last Saved`

**Notes Content format:** Quill HTML â€” `<ul><li>text</li><li class="ql-indent-1">sub-bullet</li></ul><p><br></p>`

**Frontend:** `NotesEditor.html` is a sidebar using Quill.js. Opened via `openNotesSidebar()` from the custom menu.

**Key functions in `AccountNotes.js`:**
- `getAccountListForNotes()` â€” returns active accounts with `{ id, name, hasNotes }` (same active-account filter as AccountDataRaw)
- `loadAccountNotes(accountId)` â€” returns `{ content, lastSaved }` for an account
- `saveAccountNotes(accountId, accountName, content)` â€” upserts a row in Notes Storage

**Notes only show active accounts** in the dropdown. Inactive accounts retain their notes in the sheet but won't appear in the editor unless you look them up directly.

---

## Automation Schedule

All triggers are time-based and set up via the custom menu or by running setup functions in Apps Script.

| Time | What Runs | Function |
|---|---|---|
| Daily ~2am MST | CSV imports (Renewal Opps, Opptys Report, Accounts Card) | `importAllCSVs()` |
| Daily ~3am MST | New customer detection + Account Data Raw regeneration | `detectNewCustomers()` â†’ `generateAccountDataRaw()` |
| Every 15 min | Email import by domain | `importEmailsByDomain()` |
| Every 15 min | Calendar import | `importCalendarEvents()` |
| Every 1â€“5 min | GitHub task sync | `importGitHubTasks()` |

**To set up triggers:** Use the `OP Account Tools` custom menu in the spreadsheet, or run the `setup*` functions directly in Apps Script editor.

---

## Custom Menu Structure

The `OP Account Tools` menu is built in `EmailToSheet.js` `onOpen()`:

```
OP Account Tools
â”œâ”€â”€ ğŸ“¥ Email Import
â”‚   â”œâ”€â”€ Import All CSVs
â”‚   â”œâ”€â”€ Import: Renewal Opportunities
â”‚   â”œâ”€â”€ Import: Opptys Report
â”‚   â”œâ”€â”€ Import: Accounts Card Report
â”‚   â”œâ”€â”€ Setup Auto-Import
â”‚   â””â”€â”€ Test Email Search
â”œâ”€â”€ ğŸ“… Calendar Import
â”‚   â”œâ”€â”€ Import Calendar Events
â”‚   â””â”€â”€ Setup Auto-Import (15 min)
â”œâ”€â”€ ğŸ™ GitHub
â”‚   â”œâ”€â”€ Import GitHub Tasks
â”‚   â””â”€â”€ Setup Auto-Import
â”œâ”€â”€ ğŸ“Š Account Data Raw
â”‚   â””â”€â”€ Generate Account Data Raw
â”œâ”€â”€ ğŸ†• Customer Lifecycle
â”‚   â”œâ”€â”€ Check for New Customers
â”‚   â””â”€â”€ Setup Auto-Detection (Daily)
â”œâ”€â”€ ğŸ“ Account Notes
â”‚   â””â”€â”€ Open Notes Editor
â””â”€â”€ ğŸ”§ Data Integrity
    â”œâ”€â”€ Fix Email Account References
    â”œâ”€â”€ Comprehensive Table Remapping
    â””â”€â”€ Fix Missing Meeting Recap Accounts
```

---

## Table Relationships (Foreign Keys)

```
Accounts Card Report
â”œâ”€â”€ Id (PK â€” Salesforce Account ID)
â””â”€â”€ next_renewal_opportunity_id â†’ Opptys Report.Id

Opptys Report
â”œâ”€â”€ Id (PK)
â””â”€â”€ Name â†’ Renewal Opportunities (via extractOpportunityNameFromLink)

Renewal Opportunities
â””â”€â”€ Link to SF Opportunity â†’ Opptys Report.Name (URL-encoded in link)

Accounts to Email Domains Mapping
â””â”€â”€ Account ID â†’ Accounts Card Report.Id

Email Communications
â”œâ”€â”€ Message ID (PK)
â”œâ”€â”€ Account ID â†’ Accounts Card Report.Id
â””â”€â”€ Account Name (display only, denormalized)

Calendar Events
â”œâ”€â”€ Event ID (PK)
â”œâ”€â”€ Account ID â†’ Accounts Card Report.Id
â””â”€â”€ Meeting Recap ID â†’ Webhook Meeting Recaps.Meeting Recap ID

GitHub Tasks
â”œâ”€â”€ Task ID (PK)
â””â”€â”€ Account ID â†’ Accounts Card Report.Id (via label matching)

Webhook Meeting Recaps
â”œâ”€â”€ Meeting Recap ID (PK, format: ngmt_01KFXKBAV0R7S2VBVK3QSBHMR3)
â”œâ”€â”€ Account ID â†’ Accounts Card Report.Id
â””â”€â”€ Calendar Event ID â†’ Calendar Events.Event ID

Meeting Action Items
â”œâ”€â”€ Meeting Recap ID + Action Item Index (composite PK)
â”‚   Concatenated ID format: {Meeting Recap ID}_{index}  e.g. ngmt_01K..._0
â”œâ”€â”€ Meeting Recap ID â†’ Webhook Meeting Recaps.Meeting Recap ID
â””â”€â”€ Account Name (denormalized)

Notes Storage
â”œâ”€â”€ Account ID â†’ Accounts Card Report.Id
â””â”€â”€ Notes Content (Quill HTML)
```

---

## Customer Lifecycle

### New Customer Added to Renewal Opportunities
**Automatic:** Detected at 3am, Account Data Raw updated, notes entry created.
**Manual required:**
1. Add email domain to `Accounts to Email Domains Mapping` sheet â€” **CRITICAL**, without this no emails/calendar/meeting recaps will match
2. Optionally add GitHub label `account: Customer Name`

### Customer Removed from Renewal Opportunities
- Status changes to "Inactive" in Account Data Raw (column B)
- All historical data (emails, calendar, GitHub, recaps, notes) is preserved â€” nothing is deleted
- Account no longer appears in Notes Editor dropdown

---

## Data Integrity Tools

Run these when data looks wrong:

| Symptom | Fix |
|---|---|
| Email Communications has names in Account ID column | `OP Account Tools â†’ ğŸ”§ Data Integrity â†’ Fix Email Account References` |
| Meeting recaps have no Account ID | Add domain to mapping sheet, then `Fix Missing Meeting Recap Accounts` |
| Account Data Raw emails/events columns are empty | Check mapping sheet, then regenerate Account Data Raw |
| Any broken foreign key references | `Comprehensive Table Remapping` â€” verifies and repairs all relationships |
| Inactive account missing from Account Data Raw | Regenerate Account Data Raw â€” it shows ALL accounts |

**`analyzeMissingDomainsManual()`** in `FixMissingAccounts.js` â€” shows which attendee domains have no mapping entry. Run this to find what to add to the mapping sheet.

---

## Calendar Events Sheet Schema

| Column | Type | Notes |
|---|---|---|
| Event ID | Text | Unique Google Calendar event ID |
| Title | Text | |
| Start Time | DateTime | |
| End Time | DateTime | |
| Duration (hours) | Number | |
| Location | Text | |
| Description | Text | |
| Is All Day | Yes/No | |
| My Status | Text | accepted/declined/tentative/needsAction |
| Creator | Email | |
| Is Recurring | Yes/No | |
| Attendee Count | Number | |
| Attendee Emails | Text | Comma-separated |
| Attendee Names | Text | Comma-separated |
| Attendee Statuses | Text | Comma-separated |
| Accepted Count | Number | |
| Declined Count | Number | |
| Tentative Count | Number | |
| No Response Count | Number | |
| Account ID | Text | Matched via domain mapping |
| Meeting Recap ID | Text | Linked to Webhook Meeting Recaps if matched |

---

## GitHub Tasks Sheet Schema

| Column | Description |
|---|---|
| Task ID | Unique GitHub project item ID |
| Type | ISSUE, DRAFT_ISSUE, or PULL_REQUEST |
| Number | Issue/PR number |
| Title | Task title |
| Status | Backlog / Blocked / Ready / In Progress / Done |
| Priority | Priority level |
| State | OPEN, CLOSED, MERGED |
| Repository | Repo name |
| URL | Direct link |
| Assignees | Comma-separated |
| Labels | Comma-separated (includes `account: Name` labels) |
| Created At | Timestamp |
| Updated At | Timestamp |
| Closed At | Timestamp |
| Account ID | Matched via `account: Name` label |

---

## Security Notes

- GitHub token stored in Apps Script Script Properties as `GITHUB_TOKEN` â€” never hardcoded in files
- The spreadsheet URL and sheet IDs are not secrets but should not be shared publicly
- Webhook endpoint is a deployed Apps Script web app URL â€” treat as semi-public (anyone with URL can POST)

---

## Common Tasks for an LLM

**Add a new Domo CSV import:**
1. Add entry to `EMAIL_CONFIGS` array in `EmailConfig.js`
2. `clasp push` â€” menu auto-updates, no other changes needed

**Add a new column to Account Data Raw:**
1. Edit `buildConsolidatedData()` in `AccountDataRaw.js`
2. Add column header to the headers array and the value to each row object
3. `clasp push`, then run `Generate Account Data Raw` from the menu

**Fix a broken account match:**
1. Check `Accounts to Email Domains Mapping` sheet for the domain
2. If missing, add it
3. Run `Fix Missing Meeting Recap Accounts` or `Fix Email Account References` as appropriate
4. Regenerate Account Data Raw

**Add a new feature that needs account context:**
- Use `AccountMapping.js` utilities for domainâ†’account lookups
- Use `Accounts Card Report` as the base account table (has `Id` and `Name` columns)
- Always store Account ID (not Account Name) as the foreign key in any new table

**Modify the notes editor:**
- Frontend: `NotesEditor.html` (Quill.js sidebar)
- Backend: `AccountNotes.js`
- Notes content is stored as Quill HTML â€” preserve `<ul>`, `<li>`, `<li class="ql-indent-N">`, `<p>`, `<a href>` tags

**Deploy changes:**
```bash
clasp push
git add -A && git commit -m "description" && git push origin main
```
